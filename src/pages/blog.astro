---
import Layout from '@/layouts/Layout.astro';
import Navbar from '@/components/Navbar.astro';

export const prerender = false;
---

<Layout title="Blog - TecnoJuy">
  <Navbar />
  <main>
    <div id="blog-container" class="min-h-screen" style="background-color: var(--bg-secondary);">
      <!-- Loading -->
      <div id="loading" class="flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2" style="border-color: var(--accent);"></div>
        <span class="ml-3" style="color: var(--text-secondary);">Cargando blog...</span>
      </div>
    </div>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const loadingEl = document.getElementById('loading');
    const containerEl = document.getElementById('blog-container');
    const currentParams = new URLSearchParams(window.location.search);
    const currentCategoryId = currentParams.get('category_id') ? Number(currentParams.get('category_id')) : null;

    try {
  // Cargar posts del blog respetando filtros/paginaci√≥n de la URL
  const params = new URLSearchParams();
  params.set('page', currentParams.get('page') || '1');
  params.set('per_page', currentParams.get('per_page') || '12');
  params.set('sort_by', currentParams.get('sort_by') || 'published_at');
  params.set('sort_order', currentParams.get('sort_order') || 'desc');
  if (currentCategoryId) params.set('category_id', String(currentCategoryId));
  
  // Usar el API del backend directamente
  const apiUrl = 'https://backend-tecnojuy2-production.up.railway.app';
  const response = await fetch(`${apiUrl}/blog/posts?${params.toString()}`);
      if (!response.ok) throw new Error('Error cargando posts');
      
      const data = await response.json();
      const posts = data.posts || [];

      // Cargar categor√≠as
      const categoriesResponse = await fetch(`${apiUrl}/blog/categories`);
      const categories = categoriesResponse.ok ? await categoriesResponse.json() : [];

      // Render del blog
      if (loadingEl) loadingEl.style.display = 'none';
      
      containerEl.innerHTML = `
        <!-- Header del Blog -->
        <div class="shadow-sm" style="background-color: var(--bg-primary);">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center">
              <h1 class="text-4xl font-bold mb-4" style="color: var(--text-primary);">Blog TecnoJuy</h1>
              <p class="text-xl max-w-2xl mx-auto" style="color: var(--text-secondary);">
                Mantente al d√≠a con las √∫ltimas noticias, cursos y novedades en tecnolog√≠a
              </p>
            </div>
          </div>
        </div>

        <!-- Categor√≠as -->
        ${categories.length > 0 ? `
        <div class="border-b" style="background-color: var(--bg-primary); border-color: var(--border-primary);">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center space-x-6 py-4 overflow-x-auto">
              <button onclick="filterByCategory(null)" class="category-btn whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-colors" style="${!currentCategoryId ? 'color: var(--accent); border-color: var(--accent);' : 'color: var(--text-secondary); border-color: transparent;'}">
                Todos
              </button>
              ${categories.map(cat => `
                <button onclick="filterByCategory(${cat.id})" class="category-btn whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent transition-colors" style="${currentCategoryId === cat.id ? 'color: var(--accent); border-color: var(--accent);' : 'color: var(--text-secondary); border-color: transparent;'}">
                  ${cat.name}
                </button>
              `).join('')}
            </div>
          </div>
        </div>
        ` : ''}

        <!-- Posts Grid -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <div id="posts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            ${posts.length > 0 ? posts.map(post => `
              <article class="rounded-lg shadow-md overflow-hidden transition-shadow" style="background-color: var(--bg-primary);" onmouseover="this.style.boxShadow='var(--shadow-lg)';" onmouseout="this.style.boxShadow='var(--shadow-md)';">
                ${post.featured_image_url ? `
                  <img src="${post.featured_image_url}" alt="${post.title}" class="w-full h-48 object-cover">
                ` : ''}
                <div class="p-6">
                  ${post.category ? `
                    <div class="mb-3">
                      <span class="inline-block px-3 py-1 text-xs font-semibold text-white rounded-full" style="background-color: ${post.category.color}">
                        ${post.category.name}
                      </span>
                    </div>
                  ` : ''}
                  
                  <h2 class="text-xl font-bold mb-3 line-clamp-2" style="color: var(--text-primary);">
                    <a href="/blog/${post.slug}" class="transition-colors" style="color: var(--text-primary);" onmouseover="this.style.color='var(--accent)';" onmouseout="this.style.color='var(--text-primary)';">
                      ${post.title}
                    </a>
                  </h2>
                  
                  ${post.excerpt ? `
                    <p class="mb-4 line-clamp-3" style="color: var(--text-secondary);">${post.excerpt}</p>
                  ` : ''}
                  
                  <div class="flex items-center justify-between text-sm" style="color: var(--text-muted);">
                    <div class="flex items-center space-x-4">
                      <span>üìÖ ${new Date(post.published_at || post.created_at).toLocaleDateString('es-ES')}</span>
                      ${post.reading_time_minutes ? `<span>‚è±Ô∏è ${post.reading_time_minutes} min</span>` : ''}
                      <span>üëÅÔ∏è ${post.views_count}</span>
                    </div>
                    ${post.is_featured ? '<span class="font-semibold" style="color: var(--secondary);">‚≠ê Destacado</span>' : ''}
                  </div>
                  
                  ${post.tags && post.tags.length > 0 ? `
                    <div class="mt-4 flex flex-wrap gap-2">
                      ${post.tags.map(tag => `
                        <span class="inline-block px-2 py-1 text-xs rounded-full" style="color: var(--accent); background-color: var(--bg-accent);">
                          #${tag.name}
                        </span>
                      `).join('')}
                    </div>
                  ` : ''}
                </div>
              </article>
            `).join('') : `
              <div class="col-span-full text-center py-12">
                <div class="text-6xl mb-4">üìù</div>
                <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">No hay posts publicados</h3>
                <p style="color: var(--text-secondary);">Vuelve pronto para ver las √∫ltimas noticias y art√≠culos.</p>
              </div>
            `}
          </div>
          
          <!-- Paginaci√≥n -->
          ${data.pages > 1 ? `
            <div class="mt-12 flex justify-center">
              <nav class="flex items-center space-x-2">
                ${data.has_prev ? `
                  <button onclick="loadPage(${data.page - 1})" class="px-3 py-2 text-sm font-medium rounded-md transition-colors" style="color: var(--text-secondary); background-color: var(--bg-primary); border: 1px solid var(--border-primary);" onmouseover="this.style.backgroundColor='var(--hover-bg)';" onmouseout="this.style.backgroundColor='var(--bg-primary)';">
                    Anterior
                  </button>
                ` : ''}
                
                <span class="px-3 py-2 text-sm font-medium" style="color: var(--text-primary);">
                  P√°gina ${data.page} de ${data.pages}
                </span>
                
                ${data.has_next ? `
                  <button onclick="loadPage(${data.page + 1})" class="px-3 py-2 text-sm font-medium rounded-md transition-colors" style="color: var(--text-secondary); background-color: var(--bg-primary); border: 1px solid var(--border-primary);" onmouseover="this.style.backgroundColor='var(--hover-bg)';" onmouseout="this.style.backgroundColor='var(--bg-primary)';">
                    Siguiente
                  </button>
                ` : ''}
              </nav>
            </div>
          ` : ''}
        </div>
      `;

      // Funciones globales para filtros y paginaci√≥n
      window.filterByCategory = (categoryId) => {
        const params = new URLSearchParams(window.location.search);
        if (categoryId) {
          params.set('category_id', String(categoryId));
        } else {
          params.delete('category_id');
        }
        params.set('page', '1'); // Reiniciar a la primera p√°gina al cambiar categor√≠a
        window.location.search = params.toString();
      };

      window.loadPage = (page) => {
        const params = new URLSearchParams(window.location.search);
        params.set('page', page.toString());
        window.location.search = params.toString();
      };

    } catch (error) {
      console.error('Error cargando blog:', error);
      if (loadingEl) loadingEl.style.display = 'none';
      
      containerEl.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
          <div class="text-6xl mb-4">üòî</div>
          <h2 class="text-2xl font-bold mb-4" style="color: var(--text-primary);">Error cargando el blog</h2>
          <p class="mb-6" style="color: var(--text-secondary);">Hubo un problema al cargar los posts. Por favor, intenta de nuevo.</p>
          <button onclick="location.reload()" class="btn-primary px-6 py-3 rounded-lg">
            üîÑ Reintentar
          </button>
        </div>
      `;
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
